<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Allsony Report</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="lib/report.css">
<script src="lib/jquery-3.3.1.min.js"></script>

<!-- https://www.jsviews.com/ -->
<script src="lib/jsrender-0.9.91.min.js"></script>

<!-- https://github.com/exif-js/exif-js -->
<script src="lib/exif.js?t=20181009"></script>

<!-- https://github.com/rossturner/HTML5-ImageUploader -->
<script src="lib/ImageUploader.js?t=20181009"></script>

<script src="teamData.js?t=20181009"></script>
<script>
var sex_name, sex_label;

function initializeImageUpload() {
	// Initialization of input elements and ImageUploader.js
	$("input.image-upload").each(function(index){
		var id_product = $(this).attr('data-product');
		var uploader = new ImageUploader({'inputElement': $(this).get(0),
			'onComplete': function() {
				// Enable upload button
				//$('#upload-button-'+id).removeProp('disabled');
				// Hide progress bar
        //$("#upload-progress").addClass("hidden");
			},
			// Add rand parameter to prevent accidental caching of the image by the server
			//'uploadUrl': 'index.html?action=upload_image&id_image=' + '&rand=' + new Date().getTime(),
			'debug': true
			});
	});

	// The function below is triggered every time the user selects a file
	$("input.image-upload").change(function(index){
		// We will check additionally the extension of the image if it's correct and we support it
		var extension = $(this).val();
		if (extension.length > 0) {
		  extension = extension.match(/[^.]+$/).pop().toLowerCase();
			extension = ~$.inArray(extension, ['jpg', 'jpeg']);
		} else {
			event.preventDefault();
			return;
    }

		if (!extension) {
			event.preventDefault();
			console.error('Unsupported image format');
			return;
		}
		// Disable upload button until current upload completes
		//$('#upload-button-'+id).prop('disabled',true);
		// Show progress bar
		//$("#upload-progress").removeClass("hidden");
    // If you want, you can show a preview of the selected image to the user, but to keep the code simple, we will skip this step
	});
}

jQuery(document).ready(function($){
  // ImageUpload ボタンの初期化
  initializeImageUpload();

  // 入力フィールドは最初は非表示
	$(".input-field").each(function(index){
    $(this).hide();
  });
  
  $("#send_report_status").hide();
});

// 男子・女子・シニアそれぞれの試合パターンを返す
function getMatchPattern() {
  var matchPatterns = {
    man : [ "S1", "S2", "D1", "D2", "D3" ],
    woman : [ "S1", "D1", "D2" ],
    senior : [ "D1", "D2", "D3" ]
  };

  if (document.getElementById("radio_man").checked) {
    return matchPatterns.man;
  }
  if (document.getElementById("radio_woman").checked) {
    return matchPatterns.woman;
  }
  if (document.getElementById("radio_senior").checked) {
    return matchPatterns.senior;
  }

  // デフォルトは男子パターンにしておく
  return matchPatterns.man;
}

// 男子・女子・シニアを選択したときの処理
function onSexUpdate() {
  sex_name = sex_label = "";
  if (document.getElementById("radio_man").checked) {
    sex_name = "man";
    sex_label = "男子";
  }
  if (document.getElementById("radio_woman").checked) {
    sex_name = "woman";
    sex_label = "女子";
  }
  if (document.getElementById("radio_senior").checked) {
    sex_name = "senior";
    sex_label = "シニア";
  }

  // 男子・女子・シニアの選択に応じて、入力すべきフィールドだけにする
  var matchPattern = getMatchPattern();
  [ "S1", "S2", "D1", "D2", "D3" ].forEach(function(match) {
    if (matchPattern.indexOf(match) != -1) {
      $("#game_" + match).show();
    } else {
      $("#game_" + match).hide();
    }
  });

  // チーム選択フィールドの設定
	$(".team-selector").each(function(index, element) {
    var teams = teamData[sex_name];

    // 既存の子ノードを削除
    $(this).empty();
    // チーム選択フィールドを設定
    teams.forEach(function(team) {
      var option = document.createElement("option");
      option.text = team;
      element.appendChild(option);
    });
  });
}

// 入力情報がアップデートされたときの処理
function onTableUpdate() {
  // match_name の設定
  var match_name = "", mail_subject = "";
  var match_league = $("#match_league option:selected");
  var match_number = $("#match_number option:selected");
  var team_L = $("#team_L option:selected");
  var team_R = $("#team_R option:selected");
  if (sex_name && match_league.val() != "" && match_number.val() != "") {
    match_name = sex_name + "_" + match_league.val() + "_No" + ("00" + match_number.val()).substr(-2);
    mail_subject = sex_label + "/" + match_league.text() + "/ 試合No" + match_number.val() + " (" + team_L.text() + " vs " + team_R.text() + ")";

    // 入力フィールドを表示させる
    $(".input-field").each(function(index){
      $(this).show();
    });
  } else {
    // 入力フィールドを非表示にする
    $(".input-field").each(function(index){
      $(this).hide();
    });
  }
  $("#mail_subject").val(mail_subject);
  $("#match_name").val(match_name);

  // 取得ゲーム数を計算する
  var matchPattern = getMatchPattern();
  var L_total = 0, R_total = 0;
  matchPattern.forEach(function(match) {
    L_total += parseInt($("#game_L_" + match).val());
    R_total += parseInt($("#game_R_" + match).val());
  });
  $("#game_L_total").text(L_total);
  $("#game_R_total").text(R_total);

  generateMailContents();
}

// メールに埋め込む部分の HTML を生成する
function generateMailContents() {
  // 上記のヒアドキュメント内のキーワードを置換する
  var data = {
    sex_label: sex_label,
    match_league: $("#match_league option:selected").text(),
    match_number: $("#match_number option:selected").text(),
    match_name: $("#match_name").val(),
    mail_subject: $("#mail_subject").val(),
    team_L: $("#team_L option:selected").text(),
    team_R: $("#team_R option:selected").text(),
    match_L: $("#match_L option:selected").text(),
    match_R: $("#match_R option:selected").text(),
    game_L_S1: $("#game_L_S1 option:selected").text(),
    game_R_S1: $("#game_R_S1 option:selected").text(),
    game_L_S2: $("#game_L_S2 option:selected").text(),
    game_R_S2: $("#game_R_S2 option:selected").text(),
    game_L_D1: $("#game_L_D1 option:selected").text(),
    game_R_D1: $("#game_R_D1 option:selected").text(),
    game_L_D2: $("#game_L_D2 option:selected").text(),
    game_R_D2: $("#game_R_D2 option:selected").text(),
    game_L_D3: $("#game_L_D3 option:selected").text(),
    game_R_D3: $("#game_R_D3 option:selected").text(),
    game_L_total: $("#game_L_total").text(),
    game_R_total: $("#game_R_total").text(),
    sender_name: $("#sender_name").val(),
    comment: $("#comment").val(),
    dummy: ""
  }
  if (data.sender_name == "") {
    data.sender_name = "<未入力>";
  }
  if (data.comment == "") {
    data.comment = "<コメントなし>";
  }
  var html = $('#mail_contents_template').render(data);

  // mailContents に表示されている HTML そのものを埋め込む (それがメールで送信される)
  $("#mail_contents").val(html);
  $("#mail_contents_view").html(html);
}

// 結果を送信する処理
function onSendReport() {
  // いったんテーブルを更新
  onTableUpdate();

  $("#send_button").text("送信中...");

  // データを送信
  $.ajax({
    url: 'send-report.php',
    type: 'post',
    dataType: 'json', // 「json」を指定するとresponseがJSONとしてパースされたオブジェクトになる
    data: {           // 送信データを指定
        mail_subject: $('#mail_subject').val(),
        mail_contents: $('#mail_contents').val(),
        match_name: $("#match_name").val(),
    },
  })
  // ・ステータスコードは正常で、dataTypeで定義したようにパース出来たとき
  .done(function (response) {
      $("#send_button").text("結果を送信する");
      $("#send_report_status").text("送信が完了しました");
      $("#send_report_status").show();
  })
  // ・サーバからステータスコード400以上が返ってきたとき
  // ・ステータスコードは正常だが、dataTypeで定義したようにパース出来なかったとき
  // ・通信に失敗したとき
  .fail(function () {
      $("#send_button").text("結果を送信する");
      $("#send_report_status").text("送信に失敗しました");
      $("#send_report_status").show();
  });
}
</script>
</head>
<body>
<header>
  <h3>Allsony Report</h3>
</header>
<div>
  <table class="table table-bordered" onChange="onTableUpdate()">
    <tr class="text-center text-nowrap table-info"><th colspan=5>試合情報</th></tr>
    <tr class="text-center">
      <th class="text-left">
        <input onclick="onSexUpdate()" type="radio" name="sex" value="man" id="radio_man"><label for="radio_man">男子</label><br>
        <input onclick="onSexUpdate()" type="radio" name="sex" value="woman" id="radio_woman"><label for="radio_woman">女子</label><br>
        <input onclick="onSexUpdate()" type="radio" name="sex" value="senior" id="radio_senior"><label for="radio_senior">シニア</label>
      </th>
      <th colspan=4 class="text-left">
        <div>
        <select id="match_league">
          <option value="">-- 試合の選択 --</option>
          <option value="woman_league">女子リーグ</option>
          <option value="senior_league">シニアリーグ</option>
          <optgroup label="男子予選">
            <option value="man_preliminary_A">予選Aリーグ</option>
            <option value="man_preliminary_B">予選Bリーグ</option>
            <option value="man_preliminary_C">予選Cリーグ</option>
            <option value="man_preliminary_D">予選Dリーグ</option>
            <option value="man_preliminary_E">予選Eリーグ</option>
            <option value="man_preliminary_F">予選Fリーグ</option>
            <option value="man_preliminary_G">予選Gリーグ</option>
            <option value="man_preliminary_H">予選Hリーグ</option>
          </optgroup>
          <optgroup label="男子本戦">
            <option value="man_final_1">決勝1位トーナメント</option>
            <option value="man_final_2">決勝2位トーナメント</option>
            <option value="man_final_3">決勝3位トーナメント</option>
            <option value="man_final_4">決勝4位トーナメント</option>
            <option value="man_final_5">決勝5位トーナメント</option>
            <option value="man_final_6">決勝6位トーナメント</option>
        </optgroup>
        </select>
        </div>
        <div>
        <select id="match_number">
          <option value="">-- 試合Noの選択 --</option>
          <option value="1">①
          <option value="2">②
          <option value="3">③
          <option value="4">④
          <option value="5">⑤
          <option value="6">⑥
          <option value="7">⑦
          <option value="8">⑧
          <option value="9">⑨
          <option value="10">⑩
          <option value="11">⑪
          <option value="12">⑫
          <option value="13">⑬
          <option value="14">⑭
          <option value="15">⑮
        </select>
        </div>
      </th>
    </tr>
  </table>
  <table class="table table-bordered input-field" onChange="onTableUpdate()">
    <tr class="text-center text-nowrap table-info"><th>自チーム名</th><th colspan=3>勝敗数</th><th>対戦チーム名</th></tr>
    <tr class="text-center">
      <td>
        <select id="team_L" class="team-selector"></select>
      </td>
      <td>
          <select id="match_L">
              <option value="0">0<option value="1">1<option value="2">2<option value="3">3
              <option value="4">4<option value="5">5
          </select>
      </td>
      <td>
          vs
      </td>
      <td>
          <select id="match_R">
              <option value="0">0<option value="1">1<option value="2">2<option value="3">3
              <option value="4">4<option value="5">5
          </select>
      </td>
      <td>
        <select id="team_R" class="team-selector"></select>
      </td>
    </tr>

    <tr class="text-center table-info"><th colspan=5>取得ゲーム数</th></tr>
    <tr id="game_S1">
      <td colspan=2 class="text-right">
        <select id="game_L_S1">
          <option value="0">0<option value="1">1<option value="2">2<option value="3">3
          <option value="4">4<option value="5">5<option value="6">6<option value="7">7
        </select>
      </td>
      <td class="text-center">S1</td>
      <td colspan=2 class="text-left">
        <select id="game_R_S1">
          <option value="0">0<option value="1">1<option value="2">2<option value="3">3
          <option value="4">4<option value="5">5<option value="6">6<option value="7">7
        </select>
      </td>
    </tr>
    <tr id="game_S2">
      <td colspan=2 class="text-right">
        <select id="game_L_S2">
          <option value="0">0<option value="1">1<option value="2">2<option value="3">3
          <option value="4">4<option value="5">5<option value="6">6<option value="7">7
        </select>
      </td>
      <td class="text-center">S2</td>
      <td colspan=2 class="text-left">
        <select id="game_R_S2">
          <option value="0">0<option value="1">1<option value="2">2<option value="3">3
          <option value="4">4<option value="5">5<option value="6">6<option value="7">7
        </select>
      </td>
    </tr>
    <tr id="game_D1">
      <td colspan=2 class="text-right">
        <select id="game_L_D1">
          <option value="0">0<option value="1">1<option value="2">2<option value="3">3
          <option value="4">4<option value="5">5<option value="6">6<option value="7">7
        </select>
      </td>
      <td class="text-center">D1</td>
      <td colspan=2 class="text-left">
        <select id="game_R_D1">
          <option value="0">0<option value="1">1<option value="2">2<option value="3">3
          <option value="4">4<option value="5">5<option value="6">6<option value="7">7
        </select>
      </td>
    </tr>
    <tr id="game_D2">
      <td colspan=2 class="text-right">
        <select id="game_L_D2">
          <option value="0">0<option value="1">1<option value="2">2<option value="3">3
          <option value="4">4<option value="5">5<option value="6">6<option value="7">7
        </select>
      </td>
      <td class="text-center">D2</td>
      <td colspan=2 class="text-left">
        <select id="game_R_D2">
          <option value="0">0<option value="1">1<option value="2">2<option value="3">3
          <option value="4">4<option value="5">5<option value="6">6<option value="7">7
        </select>
      </td>
    </tr>
    <tr id="game_D3">
      <td colspan=2 class="text-right">
        <select id="game_L_D3">
          <option value="0">0<option value="1">1<option value="2">2<option value="3">3
          <option value="4">4<option value="5">5<option value="6">6<option value="7">7
        </select>
      </td>
      <td class="text-center">D3</td>
      <td colspan=2 class="text-left">
        <select id="game_R_D3">
          <option value="0">0<option value="1">1<option value="2">2<option value="3">3
          <option value="4">4<option value="5">5<option value="6">6<option value="7">7
        </select>
      </td>
    </tr>
    <tr>
      <td colspan=2 class="text-right" id="game_L_total">0</td>
      <td class="text-center">合計</td>
      <td colspan=2 class="text-left" id="game_R_total">0</td>
    </tr>

    <tr class="table-info"><th colspan=5>オーダー用紙の画像添付</th></tr>
    <tr><td colspan=5>
      <input class="image-upload" data-id="1" id="uploadImage3" type="file" name="images[1]" accept="image/jpeg,image/jpg" data-product="1034">
      <div class="hidden" id="upload-progress">Uploading, please wait...</div>

    </td></tr>
    <tr class="table-info"><th colspan=5>送信者のお名前</th></tr>
    <tr><td colspan=5>
      <input type="text" name="sender_name" id="sender_name" placeholder="名前を入力してください">
    </td></tr>
    <tr class="table-info"><th colspan=5>スタッフへの連絡事項 (もしあれば)</th></tr>
    <tr><td colspan=5>
      <textarea name="comment" id="comment" rows="4" cols="30" placeholder="スタッフに伝えたいことがあれば、ここに入力してください"></textarea>
    </td></tr>
    <tr><td colspan=5 class="text-center">
      <button onClick="onSendReport()" id="send_button">結果を送信する</button>
      <div id="send_report_status">送信結果</div>
    </td></tr>
  </table>

  <input type="hidden" name="mail_contents" id="mail_contents" value="">
  <input type="hidden" name="match_name" id="match_name" value="">
  <input type="hidden" name="mail_subject" id="mail_subject" value="">

</div>

<!-- メールに表示される内容をレビューしたい場合は、下記のコメントアウトを外して表示させる -->
<hr>
<h3>下記はデバッグ用の表示です。本番は非表示になります。</h3>
<div id="mail_contents_view"></div>

<!-- メールのテンプレート -->
<script id="mail_contents_template" type="text/x-jsrender">
  <table class="table table-bordered table-mail">
    <tr class="text-center text-nowrap table-info"><th colspan=5>試合情報</th></tr>
    <tr class="text-center">
      <th colspan=5>
        {{:sex_label}} / {{:match_league}} / 試合No {{:match_number}}<br>
      </th>
    </tr>
    <tr class="text-center text-nowrap table-info"><th>自チーム名</th><th colspan=3>勝敗数</th><th>対戦チーム名</th></tr>
    <tr class="text-center">
      <td>{{:team_L}}</td>
      <td>{{:match_L}}</td>
      <td>vs</td>
      <td>{{:match_R}}</td>
      <td>{{:team_R}}</td>
    </tr>
  
    <tr class="text-center table-info"><th colspan=5>取得ゲーム数</th></tr>
    {{if sex_label == "男子" || sex_label == "女子"}}
    <tr>
      <td colspan=2 class="text-right">{{:game_L_S1}}</td>
      <td class="text-center">S1</td>
      <td colspan=2 class="text-left">{{:game_R_S1}}</td></td>
    </tr>
    {{/if}}
    {{if sex_label == "男子"}}
    <tr>
      <td colspan=2 class="text-right">{{:game_L_S2}}</td>
      <td class="text-center">S2</td>
      <td colspan=2 class="text-left">{{:game_R_S2}}</td></td>
    </tr>
    {{/if}}
    <tr>
      <td colspan=2 class="text-right">{{:game_L_D1}}</td>
      <td class="text-center">D1</td>
      <td colspan=2 class="text-left">{{:game_R_D1}}</td></td>
    </tr>
    <tr>
      <td colspan=2 class="text-right">{{:game_L_D2}}</td>
      <td class="text-center">D2</td>
      <td colspan=2 class="text-left">{{:game_R_D2}}</td></td>
    </tr>
    {{if sex_label == "男子" || sex_label == "シニア"}}
    <tr>
      <td colspan=2 class="text-right">{{:game_L_D3}}</td>
      <td class="text-center">D3</td>
      <td colspan=2 class="text-left">{{:game_R_D3}}</td></td>
    </tr>
    {{/if}}
    <tr>
      <td colspan=2 class="text-right">{{:game_L_total}}</td>
      <td class="text-center">合計</td>
      <td colspan=2 class="text-left">{{:game_R_total}}</td>
    </tr>

    <tr class="table-info"><th colspan=5>送信者のお名前</th></tr>
    <tr><td colspan=5>{{>sender_name}}</td></tr>
    <tr class="table-info"><th colspan=5>スタッフへの連絡事項 (もしあれば)</th></tr>
    <tr><td colspan=5><pre>{{>comment}}</pre></td></tr>
  </table>

  <div>MailSubject: {{:mail_subject}}</div>
  <div>Keywords: {{:match_name}}<div>
</script>

</body>
</html>
